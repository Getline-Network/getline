version: 2
jobs:
    dapp_lint:
        docker:
            - image: node:8.7
        working_directory: ~/project/dapp
        steps:
            - checkout:
                path: ~/project
            - restore_cache:
                keys:
                    - dapp1-modules-{{ checksum "yarn.lock" }}
                    - dapp1-modules
            - run: yarn
            - save_cache:
                key: dapp1-modules-{{ checksum "yarn.lock" }}
                paths:
                    - node_modules/
            - run: node_modules/.bin/solium --dir contracts/

    dapp_coverage:
        docker:
            - image: node:8.7
        working_directory: ~/project/dapp
        steps:
            - checkout:
                path: ~/project
            - restore_cache:
                keys:
                    - dapp1-modules-{{ checksum "yarn.lock" }}
                    - dapp1-modules
            - run: yarn
            - save_cache:
                key: dapp1-modules-{{ checksum "yarn.lock" }}
                paths:
                    - node_modules/
            - run: yarn run solidity-coverage
            - store_artifacts:
                path: ~/project/dapp/coverage

    dapp_test:
        docker:
            - image: node:8.7
        working_directory: ~/project/dapp
        steps:
            - checkout:
                path: ~/project
            - run: mkdir ~/project/dapp/junit
            - restore_cache:
                keys:
                    - dapp1-modules-{{ checksum "yarn.lock" }}
                    - dapp1-modules
            - run: yarn
            - save_cache:
                key: dapp1-modules-{{ checksum "yarn.lock" }}
                paths:
                    - node_modules/
            - run:
                command: sh test.sh
                environment:
                    MOCHA_FILE: junit/test-results.xml
            - store_test_results:
                path: ~/project/dapp/junit
            - store_artifacts:
                path: ~/project/dapp/junit
    
    getline_ts_build:
        docker:
            - image: getline/ci-frontend:latest
        working_directory: ~/project/getline.ts
        steps:
            - checkout:
                path: ~/project
            - restore_cache:
                keys:
                    - getlinets1-modules-{{ checksum "yarn.lock" }}
                    - getlinets1-modules
            - run: yarn
            - save_cache:
                key: getlinets1-modules-{{ checksum "yarn.lock" }}
                paths:
                    - node_modules/
            - run:
                command: yarn generate
            - run:
                command: yarn tsc
        
    frontend_build:
        docker:
            - image: getline/ci-frontend:latest
        working_directory: ~/project/frontend
        steps:
            - checkout:
                path: ~/project
            - restore_cache:
                keys:
                    - frontend1-modules-{{ checksum "yarn.lock" }}
                    - frontend1-modules
            - run: yarn
            - save_cache:
                key: frontend1-modules-{{ checksum "yarn.lock" }}
                paths:
                    - node_modules/
            - run:
                command: yarn build
            - store_artifacts:
                path: ~/project/frontend/dist

workflows:
    version: 2
    frontend:
        jobs:
            - getline_ts_build
            - frontend_build:
                requires:
                  - getline_ts_build
    dapp:
        jobs:
            - dapp_test
            - dapp_lint
            - dapp_coverage
